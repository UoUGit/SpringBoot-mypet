<html layout:decorate="~{layout}">
<div layout:fragment="content" class="container">
   <div class="inner item_wrap">
    <span class="order_id">주문 번호: <span th:text="${order.id}"></span></span>
    <h2>주문 목록</h2>
    <table>
        <thead>
            <tr>
                <th>상품명</th>
                <th>수량</th>
                <th>가격</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="item : ${order.items}">
                <td th:text="${item.item.name}"></td>
                <td th:text="${item.quantity}"></td>
                <td><span th:text="${#numbers.formatInteger(item.item.price, 3, 'COMMA')}"></span>원</td>
            </tr>
        </tbody>
    </table>
     <p>총 가격: <span id="totalPrice" th:text="${#numbers.formatInteger(order.totalPrice, 3, 'COMMA')}"></span></p>
    
    <div class="btn_wrap_B">
    	<button id="payBtn" class="btn">결제하기</button>
	</div>
	
    <script>
        document.getElementById('payBtn').addEventListener('click', function() {
            var totalPriceElement = document.getElementById('totalPrice');
            if (totalPriceElement) {
                var totalPrice = parseFloat(totalPriceElement.innerText);

                // 아임포트 결제 요청 데이터 설정
                var IMP = window.IMP; // 'IMP' 객체는 스크립트 로드 후 사용 가능
                IMP.init("imp23004612"); // 아임포트 가맹점 키로 교체

                IMP.request_pay({
                    pg: "html5_inicis", // 또는 다른 PG사 선택
                    pay_method: "card", // 카드 결제 방식
                    merchant_uid: "merchant_" + new Date().getTime(),
                    amount: totalPrice, // 동적으로 가져온 결제 금액
                    name: "Product Name",
                    buyer_name: "Buyer Name",
                    buyer_email: "buyer@example.com",
                    buyer_tel: "010-1234-5678",
                    buyer_addr: "서울특별시 강남구",
                    buyer_postcode: "123-456",
                    m_redirect_url: "/order/success" // 결제 완료 후 리디렉션될 URL
                }, function(rsp) {
                    if (rsp.success) {
                        var imp_uid = rsp.imp_uid;
                        var merchant_uid = rsp.merchant_uid;
                        var amount = rsp.paid_amount;

                        // 결제 완료 후 서버로 결제 정보를 전송
                        fetch('/api/payments/verify-payment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                impUid: imp_uid,
                                amount: amount
                            })
                        }).then(response => response.text())
                          .then(data => {
                              console.log('Success:', data);
                              window.location.href = '/order/success'; // 성공 페이지로 리디렉션
                          }).catch((error) => {
                              console.error('Error:', error);
                          });
                    } else {
                        alert('결제에 실패했습니다: ' + rsp.error_msg);
                    }
                });
            } else {
                alert('Total Price element가 페이지에 존재하지 않습니다.');
            }
        });
    </script>

</div>
</div>
</html>
