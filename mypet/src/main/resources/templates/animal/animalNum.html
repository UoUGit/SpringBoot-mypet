<html layout:decorate="~{layout}">
<body>
<div layout:fragment="content" class="container">
<div class="inner animal_wrap animal_num">
    <div class="title_wrap">
		<h2>동물등록번호 검색</h2>
		<p>※ 동물등록번호 검색의 경우 소유주가 동물보호관리시스템에 회원가입이 되어 있고,<br>
                소유주의 정보가 등록되어 있어야 정상적으로 조회가 가능합니다.</p>
		<p>※ 임의로 동물등록 사항을 확인하는 것을 방지하기 위하여, 소유주의 개인정보를 추가 입력하여야 동물등록번호 검색이 가능합니다.</p>
	</div>
	<div class="sub_wrap">
		<a th:href="@{/animal/animalBoard}">유기동물 입양</a>
		<a th:href="@{/animal/animalNum}" class="active">동물 등록 번호 검색</a>
		<a th:href="@{/animal/animalShelters}">주변 보호소 검색</a>
	</div>
    <div class="search_wrap">
        <input type="text" id="abdmIdInput" placeholder="동물등록번호">
        <button id="searchButton" class='btn'>검색</button>
    </div>
    <div id="animalResults" class="animal-list"></div>

<script layout:fragment="script" type="text/javascript">
$(document).ready(function() {
    $('#searchButton').click(function() {
        var abdmId = $('#abdmIdInput').val().trim();
        if (abdmId !== '') {
            console.log('Searching for animal with ID:', abdmId);
            $.ajax({
                type: 'GET',
                url: '/animal/' + abdmId,
                success: function(response) {
                    console.log('Response received:', response);
                    displayAnimals([response]);
                },
                error: function(xhr, status, error) {
                    alert('동물 정보를 찾을 수 없습니다.');
                    console.error('Error:', error);
                    console.error('Status:', status);
                    console.error('XHR:', xhr);
                }
            });
        } else {
            alert('동물등록번호를 입력해주세요.');
        }
    });

    function displayAnimals(animals) {
        $('#animalResults').empty();
        animals.forEach(function(animal) {
            var imageUrl = '';
            if (animal.imageCours) {
                imageUrl = animal.imageCours.startsWith('http') ? animal.imageCours : 'http://' + animal.imageCours;
            } else if (animal.photoUrl) {
                imageUrl = animal.photoUrl.startsWith('http') ? animal.photoUrl : 'http://' + animal.photoUrl;
            } else {
                imageUrl = 'https://loremflickr.com/cache/resized/521_31094492753_0bb59abbde_z_600_400_nofilter.jpg'; // 기본 이미지 경로 설정
            }
            
            var spec = '';
            if (animal.speciesNm) {
                if (animal.speciesNm.includes('개')) {
                	spec = '강아지';
                } else if (animal.speciesNm.includes('고양이')) {
                	spec = '고양이';
                } else {
                	spec = '기타축종';
                }
            } else if(animal.spcs) {
            	if (animal.spcs.includes('DOG')) {
                	spec = '강아지';
                } else if (animal.spcs.includes('CAT')) {
                	spec = '고양이';
                } else {
                	spec = '기타축종';
                }
            } else {
            	spec = '';
            }
                       
            var ageText = '';
            var currentYear = new Date().getFullYear();
            if (animal.ageInfo) {
                var birthYear = parseInt(animal.ageInfo.split(' ')[0]); // 연도만 추출 (예: "2021년")
                var age = currentYear - birthYear;
                ageText = age + '세';
            } else if (animal.age) {
            	var ageParts =  parseInt(animal.age.split('(세)')[0]);
                age = ageParts + 1
                ageText = age + '세';
                 
            } 
            else {
                ageText = ''; // 나이 정보가 없는 경우 빈 문자열
            }
            
            var breeds = '';
            if (animal.speciesNm) {
                var parts = animal.speciesNm.split('] ');
                if (parts.length > 1) {
                    breeds = parts[1];
                }
            } else if (animal.breeds) {
            	breeds = animal.breeds;
            }
            
            var sex = '';
            if (animal.sexNm) {
            	if (animal.sexNm.includes('M')) {
            		sex = '수컷';
                } else if (animal.sexNm.includes('W')) {
                	sex = '암컷';
                } else {
                	sex = '성별미상';
                }
            } else if (animal.sexdstn) {
            	if (animal.sexdstn.includes('M') ) {
            		sex = '수컷';
                } else if (animal.sexdstn.includes('W') ) {
                	sex = '암컷';
                } else {
                	sex = '성별미상';
                }
            } else {
            	sex = '';
            }
            
            var region = '';
            if (animal.jurisdInstNm) {
            	region = animal.jurisdInstNm;
            } else if (animal.nm) {
            	var find = animal.nm.indexOf('(');
            	region = '서울특별시 (' + animal.nm.substring(find+1);
            } else {
            	region = '';
            }
                             
            var animalHtml = 
            	'<div class="animal-item">' +
                '<a href="/animal/animalDetails/' + (animal.abdmIdntfyNo ? animal.abdmIdntfyNo : '') + '">' +
                '<div class="animal_img ' + (animal.photoUrl ? '' : 'empty') + '" ' +
                   (animal.photoUrl ? 'style="background:url(' + imageUrl + ') no-repeat center / cover;"' : '') +
                   'aria-label="동물 이미지">' + '</div>' +
                    '<div class="text_wrap">' +
                        '<span class="spcs">' +
                            '<p>' + spec + '</p>' +
                        '</span>' +
                        '<ul class="info_title">' +
                            '<li>' + (breeds ? breeds : '') + '</li>' +
                            '<li>' + (ageText ? ageText : '') + '</li>' +
                            '<li>' + (sex ? sex : '') + '</li>' +
                        '</ul>' +
                        '<p>지역: <span>' + (region ? region : '') + '</span></p>' +
                    '</div>' +
                '</a>' +
            '</div>';
            $('#animalResults').append(animalHtml);
        });
    }
});
</script>
</div>
</div>
</body>
</html>
